---
title: "Disease_Control Vs Disease_Treatment"
author: "aungmyatphyo"
date: "2023-05-11"
output: html_document
---
Required Package
```{R, message=F, warning=F}
library(dplyr)
library(biomaRt)
library(tximport)
library(rhdf5)
library(gplots)
library(org.Hs.eg.db)
library(DESeq2)
library(DT)
library(apeglm)
library(RColorBrewer)
library(IHW)
library(PCAtools)
library(pheatmap)
library(clusterProfiler)
library(EnhancedVolcano)
library(ComplexHeatmap)
library(clusterProfiler)
library(circlize)
library(fgsea)
library(tidyverse)
library(ggpubr)
library(ReactomePA)
library(vsn)
library(hexbin)
library(ggnewscale)
library(pathview)
library(sf)
library(lubridate)
library(scales)
library(ggplot2)
library(tidyr)
library(colorspace)
library(colorblindr)
```

```{r}
setwd("~/Downloads")
```

Directory
```{r, message=F, warning=F}
# path where your extracted the tar.gz folder to.
# strip the trailing '/'
quant_dir <- "/Users/aungphyo/Downloads/Kallisto"
list.files(quant_dir)
```

Metadata
```{R}
samples <- read.csv(paste0(quant_dir, "/samples.csv"), header=T, row.names = "row", stringsAsFactors = T)
samples
```

Convert numeric to factor
```{R, message=F, warning=F}
samples$replicate <- factor(samples$replicate)

# check its ok:
sapply(samples, is.factor)
```

Stage Kallisto Files
```{R, message=F, warning=F}
files <- file.path(quant_dir, rownames(samples), "abundance.h5")
names(files) <- paste0(rownames(samples))
files
```

BiomaRT Ensembl
```{R, warning=F, message=F}
mart <- useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")
```

Transcript to gene
```{R, message=F, warning=F}
## show how to identify attribute type
# $ head /data/github/quant/ctrl_1/abundance.tsv

## show how to query mart
listAttributes(mart)

tx2gene <- getBM(attributes = c("ensembl_transcript_id_version", "hgnc_symbol"), mart = mart, useCache = FALSE)

head(tx2gene)
```

TXI object
```{R, message=F, warning=F}
txi <- tximport(files, type = "kallisto", tx2gene = tx2gene)
head(txi$counts)
```

Beware 
DDS object
```{R, message=F, warning=F}
dds <- DESeqDataSetFromTximport(txi, colData = samples, design = ~ replicate + condition )
```


Start to change case by case
Relevel
```{R, message=F, warning=F}


dds$condition <- relevel(dds$condition, ref = "Degenerated_control")
dds <- DESeq(dds)
resultsNames(dds)


```

extract counts
```{R, message=F, warning=F}
counts <- counts(dds, normalized=TRUE)
```

transform counts
```{R, message=F, warning=F}
## DESeq2 is weird about extracting transformations as a matrix - you must use `assay()` 
log2 <- assay(normTransform(dds))
rld <- assay(rlog(dds))
```



```{R, meassage=F, warning=F}
## x-axis is the transformed mean not the raw mean..

log2_plt <- meanSdPlot(log2, ranks=FALSE, plot=FALSE)
log2_plt$gg + ggtitle("Log2 + PC Transformation") + xlim(0,20)

rld_plt <- meanSdPlot(rld, ranks=FALSE, plot=FALSE)
rld_plt$gg + ggtitle("Rlog Transformation") + xlim(0,20)
```


Sample heatmap
```{r}
rld <- assay(rlog(dds))
sampleDists <- dist(t(rld))

## Place distances in matrix
sampleDistMatrix <- as.matrix(sampleDists)

## Optional, remove colnames
colnames(sampleDistMatrix) <- NULL

## create annotation dataframe
ann <- data.frame(Condition = samples$condition)

col <- c("blue", "red1")
names(col) <- c("treatment", "control")
ann_col <- list(Condition = col)

## match annotation rownames to distance mat
rownames(ann) <- rownames(sampleDistMatrix)

pheatmap(mat=sampleDistMatrix,
         ## pass distance metric calculated to heatmap
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         ## pass annotation dataframe 
         ## add colors
         #annotation_colors = ann_col,
         ## heatmap colours
         col=hcl.colors(100,"GnBu",rev=T))
```


PCA
```{R, message=F,warning=F, fig.width=7, fig.height=5}
p <- pca(rld, metadata = samples)

biplot(p,
       colby = 'condition',
       colkey = c('healthy_treatment'='royalblue', 'healthy_control'='red1',
                  'healthy_cytokine' = 'forestgreen', 'disease_control' = 'purple',
                  'disease_treatment' = 'gold'),
       ellipse = T,
       hline = 0,
       vline = 0,
       legendPosition = 'right',
       legendLabSize = 12,
       legendIconSize = 8.0,
       title = 'PCA bi-plot',
       subtitle = 'PC1 versus PC2')
```

DESeq
```{R, message=F, warning=F}
# make healthy_cytokine vs healthy_control
d_con_vs_d_treat <- results(dds, filterFun=ihw, alpha=0.05, c("condition", "Degenerated_treated", "Degenerated_control"))
res1 <- lfcShrink(dds=dds, res=d_con_vs_d_treat, coef=4, type="apeglm")
summary(res1)
res1
```
```{r,fig.width=7}
x=as.data.frame(res1)
x$gene=rownames(x)
#d <- plotCounts(dds, gene="RPS3", intgroup = "condition", returnData = T)
plotCounts(dds, gene="TUFM", intgroup = "condition", returnData = F)
```
function
```{r}
#resdf<- as.data.frame(res)
get_upregulated <- function(df){

	key <- intersect(rownames(df)[which(df$log2FoldChange>=1)], rownames(df)[which(df$padj<=0.05)])

    results <- as.data.frame((df)[which(rownames(df) %in% key),])
	return(results)
}

get_downregulated <- function(df){

  	key <- intersect(rownames(df)[which(df$log2FoldChange<=-1)],rownames(df)[which(df$padj<=0.05)])

  	results <- as.data.frame((df)[which(rownames(df) %in% key),])
  	return(results)
}

de_up <- get_upregulated(as.data.frame(res1))
de_up

de_down <- get_downregulated(as.data.frame(res1))
de_down

de1<-get_upregulated(as.data.frame(d_con_vs_d_treat))
#de1

de2<-get_downregulated(as.data.frame(d_con_vs_d_treat))
#de2
```

```{r, fig.height=3,fig.width=6}
## remove NA values from results
library(EnhancedVolcano)
res <- results(dds, alpha=0.5, c('condition','Degenerated_control','Degenerated_treated'))
res1 <- na.omit(res)

## calculate min/max axis values for plot (optional)
min_width <- min(res1$log2FoldChange)
max_width <- max(res1$log2FoldChange)
max_height <- -log10(min(res1[res1$pvalue>0, 5]))

## Grab top 10 up-reg genes for plot
up <- subset(res1, res1$log2FoldChange > 1 & res1$pvalue <= 0.05)
up <- up[order(-up$log2FoldChange),]
up_list <- head(rownames(up), n=2L)
up_list
## Grab top 10 down-reg genes for plot
down <- subset(res1, res1$log2FoldChange < -1 & res1$pvalue <= 0.05)
down <- down[order(down$log2FoldChange),]
down_list <- head(rownames(down), n=2L)
down_list

## place top 20 DE genes in vector (optinal...)
plot_top_20 <- c(up_list, down_list)
plot_top_20
pdf("~/Desktop/D_Treated_D_Con_volano.pdf",width=5, height=5)
EnhancedVolcano(res1,
                lab=NA,
          		x="log2FoldChange",
          		y="pvalue",
          		selectLab=plot_top_20,
          		drawConnectors=TRUE,
          		legendPosition = "none",
          		FCcutoff=1.0,
          		pCutoff=0.05,
          		pointSize = 1.3,
          		title="",
          		subtitle="",
          		caption = NA,
          		xlim=c(-10, 10),
          		ylim=c(0, max_height))
```




```{R, message=F, warning=F}
# without apeglm - not shrinkage
plotMA(d_con_vs_d_treat, ylim=c(-10,10))

# with shrinkage estimator - keep this plot
plotMA(res1, ylim=c(-10,12))
```


```{r}
# index must match samples you qre plotting
subset <- rld[, 1:6]

# now select de_up, de_down, i.e DE genes that passed the filtering our function produced
up <- rownames(de_up)
down <- rownames(de_down)

# subset matrix to include only DE genes
key <- c(up, down)
subset <- subset[which(rownames(subset) %in% key),]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c("forestgreen","blue")
names(col) <- c("Disease_treatment", "Disease_control")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = FALSE,
         annotation_col = ann,
         annotation_colors = ann_col,
         
         color = hcl.colors(100, "PRGn",rev=F))
```

```{r}
subset <- rld[, 1:6]

# now select de_up, de_down, i.e DE genes that passed the filtering our function produced
up <- rownames(de_up)
down <- rownames(de_down)

# subset matrix to include only DE genes
key <- c(up, down)
subset <- subset[which(rownames(subset) %in% key),]

mat <- t(subset)
mat <- scale(mat, center=T, scale=T)
mat <- t(mat)
mat <- na.omit(mat)

plot_top_20<-c(up_list,down_list)

top_genes <- mat[which(rownames(mat) %in% plot_top_20),]
# make group 
rownames(ann) == rownames(top_genes)


ComplexHeatmap::pheatmap(mat,
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

ComplexHeatmap::pheatmap(mat,
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```

           



### Read GMT file
```{R, message=F, warning=F}
# read in gmt file
pathway <- gmtPathways("/Users/aungphyo/Downloads/c5.all.v2023.1.Hs.symbols.gmt.txt")
head(pathway, 1)
```

### Create ranked gene list
Extract the gene names and associated log2FoldChanges from our healthy cytokine vs healthy control study to generate a ranked gene list.
```{r, message=F, warning=F}
## convert result object to dataframe
res <- as.data.frame(res1)
res$hgnc_symbol <- rownames(res)

# compute summary stat
fgsea_rank <- res %>%
              dplyr::select(hgnc_symbol, log2FoldChange) %>%
              na.omit() %>%
              distinct() %>%
              group_by(hgnc_symbol) %>%
              summarize(log2foldchange=mean(log2FoldChange))

fgsea_rank
```

### Convert to a named list
```{r}
rank <- deframe(fgsea_rank)
head(rank, 20)
```

### Run fgsea
```{R, message=F, warning=F}
# run fgsea
fgsea <- fgsea(pathways=pathway, stats=rank, nperm=7000)

fgseaResTidy <- fgsea %>%
  as_tibble() %>%
  arrange(desc(NES))

# Show in a nice table:
fgseaResTidy %>%
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>%
  arrange(padj) %>%
  DT::datatable()
```

```{r}
fdr<- p.adjust(fgseaResTidy$pval, method="fdr")
fgseaResTidy<-cbind(fgseaResTidy,fdr)
```

### Enrichment plots
I will show you can example of a pathway enriched in our lung samples, and a pathway that is enriched in Control (i.e negative NES score)

```{r}
filtered_pathway_go <- subset(fgseaResTidy, NES > 2.2)

filt_p <- as.vector(filtered_pathway_go$pathway)

for (i in filt_p){
    plt <- plotEnrichment(pathway = pathway[[i]],
    gseaParam = 1, ticksSize = 0.5, stats= rank) +
    labs(title=i) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
    print(plt)
}
```

```{r}
filtered_pathway_neg <- subset(fgseaResTidy, NES < -2.2)

filt_p <- as.vector(filtered_pathway_neg$pathway)

for (i in filt_p){
    plt <- plotEnrichment(pathway = pathway[[i]],
    gseaParam = 1, ticksSize = 0.5, stats= rank) +
    labs(title=i) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
    print(plt)
}

T1<-rbind(filtered_pathway_go,filtered_pathway_neg)
```



```{r,fig.width=5}
sub<- rbind(filtered_pathway_go,filtered_pathway_neg)
sub$pathway = gsub("GOBP_", "", sub$pathway)
pdf("~/Desktop/D_D_GO_BUBBLE.pdf", height = 5, width = 8)
ggplot(sub, aes(x=NES, y=reorder(sub$pathway,sub$NES))) + 
  geom_point(aes(color=pval, size=size)) +
  labs(title = "",
       subtitle = "",
       x="Normalised Enrichment Score",
       y=NULL,
       color='P Adj',
       size = "Gene\nnumber") +
  theme_bw()
dev.off()

```


```{r, fig.height=8, fig.width=6}
go_mf = subset(fgseaResTidy, fgseaResTidy$pathway=="GOBP_MITOCHONDRIAL_RESPIRATORY_CHAIN_COMPLEX_ASSEMBLY")
go_mf = unlist(go_mf$leadingEdge)

subset <- rld[go_mf, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "GOMF_EXTRACELLULAR_MATRIX_STRUCTURAL_CONSTITUENT",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```


```{r, fig.height=8, fig.width=6}
go_OP = subset(fgsea, fgsea$pathway=="GOBP_OXIDATIVE_PHOSPHORYLATION")
go_OP = unlist(go_OP$leadingEdge)

subset <- rld[go_OP, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "GOBP_OXIDATIVE_PHOSPHORYLATION",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```

```{r, fig.height=8, fig.width=6}
go_mito = subset(fgsea, fgsea$pathway=="GOCC_MITOCHONDRIAL_PROTEIN_CONTAINING_COMPLEX")
go_mito = unlist(go_mito$leadingEdge)

subset <- rld[go_mito, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "GOCC_MITOCHONDRIAL_PROTEIN_CONTAINING_COMPLEX",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```


```{r, fig.height=8, fig.width=6}
go_ATP= subset(fgsea, fgsea$pathway=="GOBP_ATP_SYNTHESIS_COUPLED_ELECTRON_TRANSPORT")
go_ATP = unlist(go_ATP$leadingEdge)

subset <- rld[go_ATP, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "GOBP_ATP_SYNTHESIS_COUPLED_ELECTRON_TRANSPORT",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```


```{r, fig.height=8, fig.width=5}
go_inner= subset(fgsea, fgsea$pathway=="GOCC_INNER_MITOCHONDRIAL_MEMBRANE_PROTEIN_COMPLEX")
go_inner = unlist(go_inner$leadingEdge)

subset <- rld[go_inner, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "GOCC_INNER_MITOCHONDRIAL_MEMBRANE_PROTEIN_COMPLEX",
                        labels_row = rownames(subset),
                        fontsize = 7,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```


Cluster Profiler of GO 
```{r}
df <- as.data.frame(res1)
df$hgnc_symbol <- rownames(df)
info <- getBM(attributes=c("hgnc_symbol",
                           "entrezgene_id"),
                  filters = c("hgnc_symbol"),
                  values = df$hgnc_symbol,
                  mart = mart,
                  useCache=FALSE)
tmp <- merge(df, info, by="hgnc_symbol")

# subset the dataframe to include only stat sig genes
tmp <- tmp[tmp$padj < 0.05,]

```


#OrgDb
```{r}
OrgDb <- org.Hs.eg.db

geneList <- as.vector(tmp$log2FoldChange)
names(geneList) <- as.character(tmp$entrezgene_id)
gene <- na.omit(as.character(tmp$entrezgene_id))
gene_list<-sort(geneList,decreasing = TRUE)

# GO over-representation test
ego <- clusterProfiler::enrichGO(gene          = gene,
                                 OrgDb         = OrgDb,
                                 ont           = "ALL",
                                 pAdjustMethod = "BH",
                                 pvalueCutoff  = 0.05,
                                 qvalueCutoff  = 0.01,
                                 readable      = TRUE)
summary(ego)
head(summary(ego))


```



```{r}
pdf("~/Desktop/Z1GO cluster.pdf", height = 9, width = 7)
dotplot(ego,showCategory=20,font.size=7)
```


```{r}
subset <- ego[ego$Count ==9, asis=T]
pdf("~/Desktop/DDcategory.pdf", height =4, width = 6)
cnetplot(subset, foldChange=geneList)
```

KEGG
```{R, message=F, warning=F}
# read in gmt file
pathway_kegg <- gmtPathways("/Users/aungphyo/Downloads/c2.cp.kegg.v2023.1.Hs.symbols.gmt.txt")
head(pathway_kegg, 1)
```

```{r, message=F, warning=F}
## convert result object to dataframe
res <- as.data.frame(res1)
res$hgnc_symbol <- rownames(res)

# compute summary stat
fgsea_rank <- res %>%
              dplyr::select(hgnc_symbol, log2FoldChange) %>%
              na.omit() %>%
              distinct() %>%
              group_by(hgnc_symbol) %>%
              summarize(log2foldchange=mean(log2FoldChange))

fgsea_rank
```


# create named list
```{r}
rank <- deframe(fgsea_rank)
head(rank, 20)
```

```{R, message=F, warning=F}
# run fgsea
fgsea_kegg <- fgsea(pathways=pathway_kegg, stats=rank, nperm=7000)

fgseaResTidy_kegg <- fgsea_kegg %>%
  as_tibble() %>%
  arrange(desc(NES))

# Show in a nice table:
fgseaResTidy_kegg %>%
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>%
  arrange(padj) %>%
  DT::datatable()
```

```{r}
fdr<- p.adjust(fgseaResTidy_kegg$pval, method="fdr")
fgseaResTidy_kegg<-cbind(fgseaResTidy_kegg,fdr)
```

Cluster Profiler of KEGG Analysis
```{r}
df <- as.data.frame(res1)
df$hgnc_symbol <- rownames(df)
info <- getBM(attributes=c("hgnc_symbol",
                           "entrezgene_id"),
                  filters = c("hgnc_symbol"),
                  values = df$hgnc_symbol,
                  mart = mart,
                  useCache=FALSE)
tmp <- merge(df, info, by="hgnc_symbol")

# subset the dataframe to include only stat sig genes
tmp <- tmp[tmp$padj < 0.05,]
```



```{r}
OrgDb <- org.Hs.eg.db

geneList <- as.vector(tmp$log2FoldChange)
names(geneList) <- as.character(tmp$entrezgene_id)
gene <- na.omit(as.character(tmp$entrezgene_id))
gene_list<-sort(geneList,decreasing = TRUE)
gene_list

#gene_ids <- bitr(tmp, fromType = tmp$hgnc_symbol, toType =tmp$entrezgene_id, OrgDb = org.Hs.eg.db)


# GO over-representation test
ego <- clusterProfiler::enrichKEGG(gene= gene,                                                                              organism = 'hsa',
                                   keyType = "kegg",
                                   pvalueCutoff  = 0.05,
                                   qvalueCutoff  = 0.01)

#egoKEGG<-gseKEGG(geneList = gene_list,
              #organism="hsa",
              #keyType = "kegg",
              #pvalueCutoff = 0.05,
              #pAdjustMethod = "BH")
#summary(egoKEGG)
summary(ego)
head(summary(ego))
```

```{r}
browseKEGG(ego,'hsa00190')
```

```{r}
hsa00190 <- pathview(gene.data  = gene_list,
                     pathway.id = "hsa00190",
                     species    = "hsa",
                     limit      = list(gene=max(abs(gene_list)), cpd=1))
hsa00190
```

```{r}
pdf("~/Desktop/Z1KEGG cluster.pdf", height = 7, width = 6)
dotplot(ego,x="GeneRatio",showCategory=20,font.size=7)
#dotplot(egoKEGG,x="GeneRatio",showCategory=20,font.size=6)
```



```{r}
filtered_pathway <- subset(fgseaResTidy_kegg, NES > 2.2)

filt_p <- as.vector(filtered_pathway$pathway)

for (i in filt_p){
    plt <- plotEnrichment(pathway = pathway_kegg[[i]],
    gseaParam = 1, ticksSize = 0.5, stats= rank) +
    labs(title=i) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
    print(plt)
}
```

```{r}
filtered_pathway_negkegg <- subset(fgseaResTidy_kegg, NES< - 2.2)

filt_p <- as.vector(filtered_pathway_negkegg$pathway)

for (i in filt_p){
    plt <- plotEnrichment(pathway = pathway_kegg[[i]],
    gseaParam = 1, ticksSize = 0.5, stats= rank) +
    labs(title=i) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
    print(plt)
}
T2<-filtered_pathway_negkegg
```



```{r,fig.width=5}
sub<-filtered_pathway_negkegg
q11 <- ggplot(sub, aes(x = sub$NES, y = reorder(sub$pathway,sub$NES)))+
  geom_point(aes(color=pval,size = size)) +
  ggtitle('Gene Ontology Enrichment Analysis between Disease Control and Disease Treatment')
q11<-q11+scale_x_continuous(breaks = seq(-3,3,by=0.5),
                            limits = c(-3,3))
q11<-q11+xlab('Normalised Enrichment Score ')+
  ylab('')

cb<-desaturate(palette_OkabeIto,0.25)
cb1<-cb[c(1,2)]

q11<-q11+scale_fill_manual(values=cb1)

q11<-q11+theme_bw()+theme(
  panel.background = element_rect(fill = "white"),
  panel.grid.major = element_line(size = 0.1, 
                                  linetype = 'solid',
                                  colour = "lightgrey"), 
  #remove x axis major grid line
  panel.grid.major.x = element_blank(),
  panel.grid.minor = element_line(size = 0.075, 
                                  linetype = 'solid',
                                  colour = "lightgrey"),
  #reduce the text size of x and angle into 30
  #axis.text.x = element_text(angle=30,vjust=1,hjust=1,size=6),
  #bold the title name
  plot.title = element_text(face='bold',size=16),
  plot.title.position = "plot",
  #axis.title.x = element_text(size=7),
  axis.line.y = element_blank(), 
  axis.line.x = element_blank(), 
  panel.border = element_blank()
 )
                            

q11
```
```{r, fig.height=8, fig.width=6}
kegg_neuroactive = subset(fgsea_kegg, fgsea_kegg$pathway=="KEGG_NEUROACTIVE_LIGAND_RECEPTOR_INTERACTION")
kegg_neuroactive = unlist(kegg_neuroactive$leadingEdge)


subset <- rld[kegg_neuroactive, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "KEGG_NEUROACTIVE_LIGAND_RECEPTOR_INTERACTION",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```

```{r, fig.height=8, fig.width=4}
kegg_OP = subset(fgsea_kegg, fgsea_kegg$pathway=="KEGG_OXIDATIVE_PHOSPHORYLATION")
kegg_OP = unlist(kegg_OP$leadingEdge)


subset <- rld[kegg_OP, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "KEGG_OXIDATIVE_PHOSPHORYLATION",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```







Reactome
```{R, message=F, warning=F}
# read in gmt file
pathway_reactome <- gmtPathways("/Users/aungphyo/Downloads/c2.cp.reactome.v2023.1.Hs.symbols.gmt.txt")
head(pathway_reactome, 1)
```


```{r, message=F, warning=F}
## convert result object to dataframe
res <- as.data.frame(res1)
res$hgnc_symbol <- rownames(res)

# compute summary stat
fgsea_rank <- res %>%
              dplyr::select(hgnc_symbol, log2FoldChange) %>%
              na.omit() %>%
              distinct() %>%
              group_by(hgnc_symbol) %>%
              summarize(log2foldchange=mean(log2FoldChange))

fgsea_rank
```

```{r}
rank <- deframe(fgsea_rank)
head(rank, 20)
```

```{R, message=F, warning=F}
# run fgsea
fgsea_reactome <- fgsea(pathways=pathway_reactome, stats=rank, nperm=7000)

fgseaResTidy_reactome <- fgsea_reactome %>%
  as_tibble() %>%
  arrange(desc(NES))

# Show in a nice table:
fgseaResTidy_reactome %>%
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>%
  arrange(padj) %>%
  DT::datatable()
```

```{r}
fdr<- p.adjust(fgseaResTidy_reactome$pval, method="fdr")
fgseaResTidy_reactome<-cbind(fgseaResTidy_reactome,fdr)
```
Cluster Profiler of Reactome
```{r}
df <- as.data.frame(res1)
df$hgnc_symbol <- rownames(df)
info <- getBM(attributes=c("hgnc_symbol",
                           "entrezgene_id"),
                  filters = c("hgnc_symbol"),
                  values = df$hgnc_symbol,
                  mart = mart,
                  useCache=FALSE)
tmp <- merge(df, info, by="hgnc_symbol")

# subset the dataframe to include only stat sig genes
tmp <- tmp[tmp$padj < 0.05,]
```


```{r}
OrgDb <- org.Hs.eg.db

geneList <- as.vector(tmp$log2FoldChange)
names(geneList) <- as.character(tmp$entrezgene_id)
gene <- na.omit(as.character(tmp$entrezgene_id))
gene_list<-sort(geneList,decreasing = TRUE)

#gene_ids <- bitr(tmp, fromType = tmp$hgnc_symbol, toType =tmp$entrezgene_id, OrgDb = org.Hs.eg.db)

# Reactome over-representation test
ego <- enrichPathway(gene= gene,                                                                        organism = 'human',
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.01)
summary(ego)
head(summary(ego))

```


```{r}
pdf("~/Desktop/Z1R cluster.pdf", height = 5, width = 7)
dotplot(ego,x="GeneRatio",showCategory=20,font.size=6)
#dotplot(ego_reactome,x="GeneRatio",showCategory=20,font.size=6)
```




Enrichment plot
```{r}
filtered_pathway_reactome <- subset(fgseaResTidy_reactome, NES > 2.2)

filt_p <- as.vector(filtered_pathway_reactome$pathway)

for (i in filt_p){
    plt <- plotEnrichment(pathway = pathway_reactome[[i]],
    gseaParam = 1, ticksSize = 0.5, stats= rank) +
    labs(title=i) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
    print(plt)
}
```

```{r}
filtered_pathway_negreactome <- subset(fgseaResTidy_reactome, NES <  -2.2)

filt_p <- as.vector(filtered_pathway_negreactome$pathway)

for (i in filt_p){
    plt <- plotEnrichment(pathway = pathway_reactome[[i]],
    gseaParam = 1, ticksSize = 0.5, stats= rank) +
    labs(title=i) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
    print(plt)
}
T3<-rbind(filtered_pathway_negreactome,filtered_pathway_reactome)
```


```{r,fig.width=7}
sub<-rbind(filtered_pathway_negreactome,filtered_pathway_reactome)
sub$pathway = gsub("REACTOME_", "", sub$pathway)
sub$pathway[1] = "RESPIRATORY_ELECTRON_TRANSPORT_ATP_SYNTHESIS_BY\nCHEMIOSMOTIC_COUPLING_AND_HEAT_PRODUCTION\nBY_UNCOUPLING_PROTEINS"
pdf("~/Desktop/DD_reactome_BUBBLE.pdf", height = 3, width = 7)
ggplot(sub, aes(x=NES, y=reorder(sub$pathway,sub$NES))) + 
  geom_point(aes(color=pval, size=size)) +
  labs(title = "",
       subtitle = "",
       x="Normalised Enrichment Score",
       y=NULL,
       color='P Adj',
       size = "Gene\nnumber") +
  theme_bw()
dev.off()
```



```{r, fig.height=8, fig.width=3}
reactome_mito = subset(fgsea_reactome, fgsea_reactome$pathway=="REACTOME_MITOCHONDRIAL_TRANSLATION")
reactome_mito = unlist(reactome_mito$leadingEdge)


subset <- rld[reactome_mito, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "REACTOME_MITOCHONDRIAL_TRANSLATION",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```


```{r, fig.height=8, fig.width=6}
reactome_met = subset(fgsea_reactome, fgsea_reactome$pathway=="REACTOME_ECM_PROTEOGLYCANS")
reactome_met = unlist(reactome_met$leadingEdge)


subset <- rld[reactome_met, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)


ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "REACTOME_THE_CITRIC_ACID_TCA_CYCLE_AND_RESPIRATORY_ELECTRON_TRANSPORT",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```


```{r, fig.height=8, fig.width=5}
reactome_resp = subset(fgsea_reactome, fgsea_reactome$pathway=="REACTOME_RESPIRATORY_ELECTRON_TRANSPORT")
reactome_resp= unlist(reactome_resp$leadingEdge)

subset <- rld[reactome_resp, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Degenerated_control", 3), rep("Degenerated_treated", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Degenerated_treated","Degenerated_control")
ann_col <- list(Condition = col)


pdf("~/Desktop/Z1R specific.pdf", height = 10, width = 11)
ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "REACTOME_RESPIRATORY_ELECTRON_TRANSPORT",
                        labels_row = rownames(subset),
                        fontsize = 7,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```




```{r, fig.height=8, fig.width=6}
reactome_ATPsynthesis = subset(fgsea_reactome, fgsea_reactome$pathway=="REACTOME_RESPIRATORY_ELECTRON_TRANSPORT_ATP_SYNTHESIS_BY_CHEMIOSMOTIC_COUPLING_AND_HEAT_PRODUCTION_BY_UNCOUPLING_PROTEINS")
reactome_ATPsynthesis= unlist(reactome_ATPsynthesis$leadingEdge)

subset <- rld[reactome_ATPsynthesis, 1:6]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Disease_control", 3), rep("Disease_treatment", 3)))
rownames(ann) <- rownames(mat)
col <- c( "blue","forestgreen")
names(col) <- c("Disease_treatment","Disease_control")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "REACTOME_ATPsynthesis",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```

```{r}


bubble<-rbind(T1,T2,T3)
```

```{r}
# Assuming your data frame is named "df"
write.table(bubble_df, file = "/Users/aungphyo/Downloads/file.csv", sep = ",", row.names = FALSE)

# Replace "path/to/output/file.csv" with the desired file path and name.


```