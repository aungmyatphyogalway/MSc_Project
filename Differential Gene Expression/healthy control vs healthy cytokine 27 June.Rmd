---
title: "Healthy_Control Vs Healthy_Cytokine"
author: "aungmyatphyo"
date: "2023-05-11"
output: html_document
---
Required Package
```{R, message=F, warning=F}
library(dplyr)
library(biomaRt)
library(tximport)
library(rhdf5)
library(gplots)
library(org.Hs.eg.db)
library(DESeq2)
library(DT)
library(apeglm)
library(RColorBrewer)
library(IHW)
library(PCAtools)
library(pheatmap)
library(clusterProfiler)
library(EnhancedVolcano)
library(ComplexHeatmap)
library(circlize)
library(ReactomePA)
library(fgsea)
library(tidyverse)
library(ggpubr)
library(vsn)
library(hexbin)
library(ggnewscale)
library(pathview)
library(sf)
library(lubridate)
library(scales)
library(ggplot2)
library(tidyr)
library(colorspace)
library(colorblindr)
```

```{r}
setwd("~/Downloads")
```

Directory
```{r, message=F, warning=F}
# path where your extracted the tar.gz folder to.
# strip the trailing '/'
quant_dir <- "/Users/aungphyo/Downloads/Kallisto"
list.files(quant_dir)
```

Metadata
```{R}
samples <- read.csv(paste0(quant_dir, "/samples.csv"), header=T, row.names = "row", stringsAsFactors = T)
samples
```

Convert numeric to factor
```{R, message=F, warning=F}
samples$replicate <- factor(samples$replicate)

# check its ok:
sapply(samples, is.factor)
```

Stage Kallisto Files
```{R, message=F, warning=F}
files <- file.path(quant_dir, rownames(samples), "abundance.h5")
names(files) <- paste0(rownames(samples))
files
```

BiomaRT Ensembl
```{R, warning=F, message=F}
mart <- useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")
```

Transcript to gene
```{R, message=F, warning=F}
## show how to identify attribute type
# $ head /data/github/quant/ctrl_1/abundance.tsv

## show how to query mart
listAttributes(mart)

tx2gene <- getBM(attributes = c("ensembl_transcript_id_version", "hgnc_symbol"), mart = mart, useCache = FALSE)

head(tx2gene)
```

TXI object
```{R, message=F, warning=F}
txi <- tximport(files, type = "kallisto", tx2gene = tx2gene)
head(txi$counts)
```

Beware 
DDS object
```{R, message=F, warning=F}
dds <- DESeqDataSetFromTximport(txi, colData = samples, design = ~ replicate + condition )
```


Start to change case by case
Relevel
```{R, message=F, warning=F}


dds$condition <- relevel(dds$condition, ref = "Healthy_control")
dds <- DESeq(dds)
resultsNames(dds)

```

extract counts
```{R, message=F, warning=F}
counts <- counts(dds, normalized=TRUE)
```

transform counts
```{R, message=F, warning=F}
## DESeq2 is weird about extracting transformations as a matrix - you must use `assay()` 
log2 <- assay(normTransform(dds))
rld <- assay(rlog(dds))
```



```{R, meassage=F, warning=F}

## x-axis is the transformed mean not the raw mean..

log2_plt <- meanSdPlot(log2, ranks=FALSE, plot=FALSE)
log2_plt$gg + ggtitle("Log2 + PC Transformation") + xlim(0,20)

rld_plt <- meanSdPlot(rld, ranks=FALSE, plot=FALSE)
rld_plt$gg + ggtitle("Rlog Transformation") + xlim(0,20)
```


Sample heatmap
```{r}
#rld <- assay(rlog(dds))
sampleDists <- dist(t(rld))

## Place distances in matrix
sampleDistMatrix <- as.matrix(sampleDists)

## Optional, remove colnames
colnames(sampleDistMatrix) <- NULL

## create annotation dataframe
ann <- data.frame(Condition = samples$condition)

col <- c("purple", "gold","red1","forestgreen", "royalblue")
names(col) <- unique(ann$Condition)
ann_col <- list(Condition = col)

## match annotation rownames to distance mat
rownames(ann) <- rownames(sampleDistMatrix)
pdf("~/Desktop/sampleheatmap.pdf",height=5,width=8)
pheatmap(mat=sampleDistMatrix,
         ## pass distance metric calculated to heatmap
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         legend_labels = c("0","20","40","60","80"),
         ## pass annotation dataframe 
         ## add colors
         annotation_col = ann,
         annotation_colors = ann_col,
         ## heatmap colours
         col=hcl.colors(100,"GnBu",rev=T))

dev.off()
```


PCA
```{R, message=F,warning=F, fig.width=7, fig.height=5}
p <- pca(rld, metadata = samples)
pdf("~/Desktop/PCA.pdf",height=5,width=6)
biplot(p,
       colby = 'condition',
       colkey = c('Healthy_treated'='royalblue', 'Healthy_control'='red1',
                  'Healthy_cytokine' = 'forestgreen', 'Degenerated_control' = 'purple',
                  'Degenerated_treated' = 'gold'),
       ellipse = T,
       hline = 0,
       vline = 0,  lab = NA,
       legendPosition = 'right',
       legendLabSize = 8,
       legendIconSize = 4.0,
       axisLabSize = 8,
       hlineType = "blank",
       vlineType = "blank",
       title = '',
       subtitle = '')
dev.off()
```

DESeq
```{R, message=F, warning=F}
# make healthy_cytokine vs healthy_control
h_con_v_h_cyto <- results(dds, filterFun=ihw, alpha=0.05,pAdjustMethod ='BH', c("condition", "Healthy_cytokine", "Healthy_control"))
summary(h_con_v_h_cyto)
res1 <- lfcShrink(dds=dds, res=h_con_v_h_cyto, coef=6, type="apeglm")
summary(res1)
```


```{r,fig.width=7}
x=as.data.frame(res1)
x$gene=rownames(x)
#d <- plotCounts(dds, gene="RPS3", intgroup = "condition", returnData = T)
plotCounts(dds, gene="CCL7", intgroup = "condition", returnData = F)
```



function
```{r}
#resdf<- as.data.frame(res)
get_upregulated <- function(df){

	key <- intersect(rownames(df)[which(df$log2FoldChange>=1)], rownames(df)[which(df$padj<=0.05)])

    results <- as.data.frame((df)[which(rownames(df) %in% key),])
	return(results)
}

get_downregulated <- function(df){

  	key <- intersect(rownames(df)[which(df$log2FoldChange<=-1)],rownames(df)[which(df$padj<=0.05)])

  	results <- as.data.frame((df)[which(rownames(df) %in% key),])
  	return(results)
}

de_up <- get_upregulated(as.data.frame(res1))
de_up

de_down <- get_downregulated(as.data.frame(res1))
de_down
```

```{r, fig.height=5,fig.width=6}
## remove NA values from results
library(EnhancedVolcano)
res <- results(dds, alpha=0.05, c('condition','Healthy_cytokine','Healthy_control'))
res1 <- na.omit(res)

## calculate min/max axis values for plot (optional)
min_width <- min(res1$log2FoldChange)
max_width <- max(res1$log2FoldChange)
max_height <- -log10(min(res1[res1$pvalue>0, 5]))

## Grab top 10 up-reg genes for plot
up <- subset(res1, res1$log2FoldChange > 1 & res1$pvalue <= 0.05)
up <- up[order(-up$log2FoldChange),]
up_list <- head(rownames(up), n=10L)
up_list
## Grab top 10 down-reg genes for plot
down <- subset(res1, res1$log2FoldChange < -1 & res1$pvalue <= 0.05)
down <- down[order(down$log2FoldChange),]
down_list <- head(rownames(down), n=10L)
down_list
## place top 20 DE genes in vector (optinal...)
plot_top_20 <- c(up_list)
plot_top_20
pdf("~/Desktop/HCYTO_HCTL_volcano.pdf", width = 5, height = 5)
EnhancedVolcano(res1,
                lab=NA,
          		x="log2FoldChange",
          		y="pvalue",
          		selectLab=plot_top_20,
          		drawConnectors=TRUE,
          		legendPosition = "none",
          		FCcutoff=1.0,
          		pointSize = 1.3,
          		boxedLabels = T,
          		pCutoff=0.05,
          		title="",
          		subtitle="",
          		caption = NA,
          		xlim=c(-10, 10),
          		ylim=c(0, max_height))
dev.off()
```




```{R, message=F, warning=F}
# without apeglm - not shrinkage
plotMA(h_con_v_h_cyto, ylim=c(-10,10))

# with shrinkage estimator - keep this plot
plotMA(res1, ylim=c(-10,10))
```

heatmap
```{r, fig.height=4}

# index must match samples you qre plotting
subset <- rld[, 7:12]

# now select de_up, de_down, i.e DE genes that passed the filtering our function produced
up <- rownames(de_up)
down <- rownames(de_down)

# subset matrix to include only DE genes
key <- c(up, down)
subset <- subset[which(rownames(subset) %in% key),]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c("forestgreen","blue")
names(col) <- c("Healthy_cytokine", "Healthy_control")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = FALSE,
         annotation_col = ann,
         annotation_colors = ann_col,
         
         color = hcl.colors(100, "PRGn",rev=F))
```
heatmap for top20
```{r}
subset <- rld[, 7:12]

# now select de_up, de_down, i.e DE genes that passed the filtering our function produced
up <- rownames(de_up)
down <- rownames(de_down)

# subset matrix to include only DE genes
key <- c(up, down)
subset <- subset[which(rownames(subset) %in% key),]

mat <- t(subset)
mat <- scale(mat, center=T, scale=T)
mat <- t(mat)
mat <- na.omit(mat)

plot_top_20<-c(up_list,down_list)

top_genes <- mat[which(rownames(mat) %in% plot_top_20),]
# make group 
rownames(ann) == rownames(top_genes)

#pheatmap::pheatmap(top_genes,
                   #show_rownames = T,
                   #annotation_col = ann,
                   #annotation_colors = ann_col,
                   #annotation_legend = TRUE,
                  #legend = TRUE,
                   #legend_title = "z-score",
                   #color=hcl.colors(100, 'PRGn',rev=F))
pdf("~/Desktop/G1generalheatmap.pdf", width = 5, height = 4)
ComplexHeatmap::pheatmap(top_genes,
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))
```





##GO Pathway
Read GMT file
```{R, message=F, warning=F}
# read in gmt file
pathway <- gmtPathways("/Users/aungphyo/Downloads/c5.all.v2023.1.Hs.symbols.gmt.txt")
head(pathway, 1)
```

### Create ranked gene list
Extract the gene names and associated log2FoldChanges from our healthy cytokine vs healthy control study to generate a ranked gene list.
```{r, message=F, warning=F}
## convert result object to dataframe
res <- as.data.frame(res1)
res$hgnc_symbol <- rownames(res)

# compute summary stat
fgsea_rank <- res %>%
              dplyr::select(hgnc_symbol, log2FoldChange) %>%
              na.omit() %>%
              distinct() %>%
              group_by(hgnc_symbol) %>%
              summarize(log2foldchange=mean(log2FoldChange))

fgsea_rank
```

### Convert to a named list
```{r}
rank <- deframe(fgsea_rank)
head(rank, 20)
```

### Run fgsea
```{R, message=F, warning=F}
# run fgsea
fgsea <- fgsea(pathways=pathway, stats=rank, nperm=7000)

fgseaResTidy <- fgsea %>%
  as_tibble() %>%
  arrange(desc(NES))

# Show in a nice table:
fgseaResTidy %>%
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>%
  arrange(padj) %>%
  DT::datatable()
```


```{r}
fdr<- p.adjust(fgseaResTidy$pval, method="fdr")
fgseaResTidy<-cbind(fgseaResTidy,fdr)
```

Cluster Profiler of GO Pathway
```{r}
df <- as.data.frame(res1)
df$hgnc_symbol <- rownames(df)
info <- getBM(attributes=c("hgnc_symbol",
                           "entrezgene_id"),
                  filters = c("hgnc_symbol"),
                  values = df$hgnc_symbol,
                  mart = mart,
                  useCache=FALSE)
tmp <- merge(df, info, by="hgnc_symbol")

# subset the dataframe to include only stat sig genes
tmp <- tmp[tmp$padj < 0.05,]
```

```{r}
OrgDb <- org.Hs.eg.db

geneList <- as.vector(tmp$log2FoldChange)
names(geneList) <- as.character(tmp$entrezgene_id)
gene <- na.omit(as.character(tmp$entrezgene_id))
gene_list<-sort(geneList,decreasing = TRUE)

# GO over-representation test
ego <- clusterProfiler::enrichGO(gene          = gene,
                                 OrgDb         = OrgDb,
                                 ont           = "ALL",
                                 pAdjustMethod = "BH",
                                 pvalueCutoff  = 0.05,
                                 qvalueCutoff  = 0.01,
                                 readable      = TRUE)

#GO gene set enrichment test
#ego3 <- gseGO(geneList     = gene_list,
              #OrgDb        = OrgDb,
              #ont          = "ALL",
             # minGSSize    = 100,
             #maxGSSize    = 500,
             # pvalueCutoff = 0.05,
            # verbose      = FALSE,
              #by="fgsea")
#summary(ego3)
summary(ego)
head(summary(ego))
```

```{r}
#y<-as.data.frame(ego)

#fdr<- p.adjust(y$pvalue, method="fdr")
#y<-cbind(y,fdr)
```


```{r,fig.height=3}
pdf("~/Desktop/X1Gocluster.pdf", height = 8, width = 6)
dotplot(ego,x="GeneRatio",showCategory=20,font.size=10)
```


```{r}
library(enrichplot)
pwts = pairwise_termsim(ego)
clusterProfiler::emapplot(pwts, showCategory = 4, layout = "circle")
#clusterProfiler::goplot(ego, showCategory = 2)
```

```{r}
sumA<- sum(fgseaResTidy$size)
sumA
```
```{r}
#test

# subset result to include pathways you want
sub = fgseaResTidy[1:20,]

# make sure the ?NES is ordered?
# use better colors
# pvalue or p.adj?
# title etc.. 
ggplot(sub, aes(x=NES,y=pathway)) +
  geom_point(aes(color=pval,size=size)) +
  #scale_color_gradientn(colours = rainbow(5)) +
  #labs(
   # x='Normalised Enrichment Score', y=NULL,
   #color='P-value',size='Gene\nnumber'
  #) +
  scale_x_continuous(limits = c(0, 3),
                  expand = c(0, 0),
                  breaks = seq(0,3, by = 0.5),
                   name = "NES") +
  theme(
    axis.title = element_text(face='bold'),
    axis.text = element_text(face='bold')
)
```

```{r}
library(sf)
library(dplyr)
library(lubridate)
library(scales)
library(ggplot2)
library(tidyr)
library(colorspace)
library(colorblindr)
```

```{r}
cb<-desaturate(palette_OkabeIto,0.25)
cb1<-cb[c(1,2)]
```

```{r,fig.width=5}
sub = fgseaResTidy[1:20,]

sub$pathway = gsub("GOBP_", "", sub$pathway)
sub$pathway[16] = "ANTIMICROBIAL_HUMORAL_IMMUNE_RESPONSE\nMEDIATED_BY_ANTIMICROBIAL_PEPTIDE"
pdf("~/Desktop/HCON_HCYTO_GO_BUBBLE.pdf", height = 6, width = 8)
ggplot(sub, aes(x=NES, y=reorder(sub$pathway,sub$NES))) + 
  geom_point(aes(color=pval, size=size)) +
  labs(title = "",
       subtitle = "",
       x="Normalised Enrichment Score",
       y=NULL,
       color='P Adj',
       size = "Gene\nnumber") +
  theme_bw()
dev.off()
```

```{r}
t1<-sub
```

```{r}
#dotplot(ego3,x="GeneRatio",showCategory=20,font.size=6)
```

```{r}
#ego
```

Category Plot
```{r,fig.width=8, fig.height=3}
subset <- ego[ego$Count==35, asis=TRUE]
gen<-ego[ego$Count==35, asis=TRUE]
#sub<- subset.data.frame(ego,Count=5)
#cnetplot(sub,showCategory=5)
cnetplot(gen,layout="gem", cex_category=2,cex_gene=2,cex_label_category=1,foldChange=geneList)
cnetplot(subset, layout="gem", cex_category=2,cex_gene=2,cex_label_category=1,foldChange=geneList)

```


### Enrichment plots
I will show you can example of a pathway enriched in our lung samples, and a pathway that is enriched in Control (i.e negative NES score)
```{r}
filtered_pathway <- subset(fgseaResTidy, NES > 2.7)

filt_p <- as.vector(filtered_pathway$pathway)

for (i in filt_p){
    plt <- plotEnrichment(pathway = pathway[[i]],
    gseaParam = 1, ticksSize = 0.5, stats= rank) +
    labs(title=i) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
    print(plt)
}
t1<-filtered_pathway
```


# heatmap genes in GOBP NEUTROPHIL ... (Trail Trail)
```{r}
go_bp_neutrophil_genes = subset(fgsea, fgsea$pathway=="GOBP_NEUTROPHIL_CHEMOTAXIS")
go_bp_neutrophil_genes = unlist(go_bp_neutrophil_genes$leadingEdge)


subset <- rld[go_bp_neutrophil_genes, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c( "forestgreen","blue")
names(col) <- c("Healthy_cytokine", "Healthy_control")
ann_col <- list(Condition = col)

#pheatmap(t(mat), 
         #show_rownames = TRUE,
         #annotation_col = ann,
         #annotation_colors = ann_col,
         #main = "GOBP_NEUTROPHIL_CHEMOTAXIS",
         #labels_row = rownames(subset), # figure out remove row labels
         #fontsize_row = 6,
         #color = hcl.colors(100, "PRGn",rev=F))

ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "GOBP_NEUTROPHIL_CHEMOTAXIS",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))


```

Trial Trial
```{r}
go_bp_neutrophil_migration = subset(fgsea, fgsea$pathway=="GOBP_NEUTROPHIL_MIGRATION")
go_bp_neutrophil_migration = unlist(go_bp_neutrophil_migration$leadingEdge)


subset <- rld[go_bp_neutrophil_migration, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c( "forestgreen","blue")
names(col) <- c("Healthy_cytokine", "Healthy_control")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = TRUE,
         annotation_col = ann,
         annotation_colors = ann_col,
         main = "GOBP_NEUTROPHIL_MIGRATION",
         labels_row = rownames(subset), # figure out remove row labels
         fontsize_row = 6,
         color = hcl.colors(100, "PRGn",rev=F))
pdf("~/Desktop/HCON_HCYTO_GO_NM_heatmap.pdf", height = 7.5, width = 6)
ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "GOBP_NEUTROPHIL_MIGRATION",
                        labels_row = rownames(subset),
                        fontsize = 12,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```

KEGG Pathway
```{R, message=F, warning=F}
# read in gmt file
pathway_kegg <- gmtPathways("/Users/aungphyo/Downloads/c2.cp.kegg.v2023.1.Hs.symbols.gmt.txt")
head(pathway_kegg, 1)
```

```{r, message=F, warning=F}
## convert result object to dataframe
res <- as.data.frame(res1)
res$hgnc_symbol <- rownames(res)

# compute summary stat
fgsea_rank <- res %>%
              dplyr::select(hgnc_symbol, log2FoldChange) %>%
              na.omit() %>%
              distinct() %>%
              group_by(hgnc_symbol) %>%
              summarize(log2foldchange=mean(log2FoldChange))

fgsea_rank
```
# create named list
```{r}
rank <- deframe(fgsea_rank)
head(rank, 20)
```

```{R, message=F, warning=F}
# run fgsea
fgsea_kegg <- fgsea(pathways=pathway_kegg, stats=rank, nperm=7000)

fgseaResTidy_kegg <- fgsea_kegg %>%
  as_tibble() %>%
  arrange(desc(NES))

# Show in a nice table:
fgseaResTidy_kegg %>%
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>%
  arrange(padj) %>%
  DT::datatable()
```

```{r}
#fgseaResTidy_kegg<-fgseaResTidy_kegg[,-9]
fdr<- p.adjust(fgseaResTidy_kegg$pval, method="fdr")
fgseaResTidy_kegg<-cbind(fgseaResTidy_kegg,fdr)
```

Cluster Profiler of KEGG Analysis
```{r}
df <- as.data.frame(res1)
df$hgnc_symbol <- rownames(df)
info <- getBM(attributes=c("hgnc_symbol",
                           "entrezgene_id"),
                  filters = c("hgnc_symbol"),
                  values = df$hgnc_symbol,
                  mart = mart,
                  useCache=FALSE)
tmp <- merge(df, info, by="hgnc_symbol")

# subset the dataframe to include only stat sig genes
tmp <- tmp[tmp$padj < 0.05,]
```

```{r}
OrgDb <- org.Hs.eg.db

geneList <- as.vector(tmp$log2FoldChange)
names(geneList) <- as.character(tmp$entrezgene_id)
gene <- na.omit(as.character(tmp$entrezgene_id))
gene_list<-sort(geneList,decreasing = TRUE)
gene_list

#gene_ids <- bitr(tmp, fromType = tmp$hgnc_symbol, toType =tmp$entrezgene_id, OrgDb = org.Hs.eg.db)

# GO over-representation test

ego_KEGG <- clusterProfiler::enrichKEGG(gene= gene,                                                                              organism = 'hsa',
                                   keyType = "kegg",
                                   pvalueCutoff  = 0.05,
                                   qvalueCutoff  = 0.01)

#egoKEGG<-gseKEGG(geneList = gene_list,
              #organism="hsa",
              #keyType = "kegg",
              #pvalueCutoff = 0.001,
              #pAdjustMethod = "BH")
#summary(egoKEGG)
summary(ego_KEGG)
#head(summary(ego))
```

```{r}
#y_kegg<-as.data.frame(ego_KEGG)

#fdr<- p.adjust(y_kegg$pvalue, method="fdr")
#y_kegg<-cbind(y,fdr)
```

```{r}
#browseKEGG(ego,'hsa05012')
```

```{r}
#hsa05012 <- pathview(gene.data  = gene_list,
                     #pathway.id = "hsa05012",
                     #species    = "hsa",
                     #limit      = list(gene=max(abs(gene_list)), cpd=1))
#hsa05012
```

```{r,fig.height=2.5}
pdf("~/Desktop/X1 KEGG cluster.pdf", height = 7, width = 6)
dotplot(ego_KEGG,x="GeneRatio",showCategory=20,font.size=9)
#dotplot(egoKEGG,x="GeneRatio",showCategory=20,font.size=6)
```

```{r,fig.width=8, fig.height=8}
#subset <- ego[ego$Count>=10, asis=T]
#cnetplot(ego, foldChange=geneList)
```


```{r}
filtered_pathway_kegg <- subset(fgseaResTidy_kegg, NES > 2.2)

filt_p <- as.vector(filtered_pathway_kegg$pathway)

for (i in filt_p){
    plt <- plotEnrichment(pathway = pathway_kegg[[i]],
    gseaParam = 1, ticksSize = 0.5, stats= rank) +
    labs(title=i) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
    print(plt)
}
t2<-filtered_pathway_kegg
```

```{r,fig.width=5}
sub_kegg=filtered_pathway_kegg
sub_kegg$pathway = gsub("KEGG_", "", sub_kegg$pathway)

pdf("~/Desktop/HCON_HCYTO_KEGG_BUBBLE.pdf", height = 3, width = 7)
ggplot(sub_kegg, aes(x=NES, y=reorder(sub_kegg$pathway,sub_kegg$NES))) + 
  geom_point(aes(color=pval, size=size)) +
  labs(title = "",
       subtitle = "",
       x="Normalised Enrichment Score",
       y=NULL,
       color='P Adj',
       size = "Gene\nnumber") +
  theme_bw()
dev.off()
```

```{r,fig.height=8, fig.width=6}
kegg_cytokine= subset(fgsea_kegg, fgsea_kegg$pathway=="KEGG_CYTOKINE_CYTOKINE_RECEPTOR_INTERACTION")
kegg_cytokine = unlist(kegg_cytokine$leadingEdge)


subset <- rld[kegg_cytokine, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c("forestgreen","blue")
names(col) <- c("Healthy_cytokine", "Healthy_control")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = TRUE,
         annotation_col = ann,
         annotation_colors = ann_col,
         main = "KEGG Cytokine-Cytokine Interaction",
         labels_row = rownames(subset), # figure out remove row labels
         fontsize_row = 6,
         color = hcl.colors(100, "PRGn",rev=F))
pdf("~/Desktop/X1 KEGG cytokine specific.pdf", height = 8, width = 7)
ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "KEGG Cytokine-Cytokine Interaction",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))
```


```{r,fig.height=8, fig.width=6}
kegg_cytokine= subset(fgsea_kegg, fgsea_kegg$pathway=="KEGG_NOD_LIKE_RECEPTOR_SIGNALING_PATHWAY")
kegg_cytokine = unlist(kegg_cytokine$leadingEdge)


subset <- rld[kegg_cytokine, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c("forestgreen","blue")
names(col) <- c("Healthy_cytokine", "Healthy_control")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = TRUE,
         annotation_col = ann,
         annotation_colors = ann_col,
         main = "KEGG Oxydative Phosphorylation",
         labels_row = rownames(subset), # figure out remove row labels
         fontsize_row = 6,
         color = hcl.colors(100, "PRGn",rev=F))


ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "KEGG_NOD_LIKE_RECEPTOR_SIGNALING_PATHWAY",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```


```{r,fig.height=8, fig.width=6}
kegg_cytokine= subset(fgsea_kegg, fgsea_kegg$pathway=="KEGG_CHEMOKINE_SIGNALING_PATHWAY")
kegg_cytokine = unlist(kegg_cytokine$leadingEdge)


subset <- rld[kegg_cytokine, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c("forestgreen","blue")
names(col) <- c("Healthy_cytokine", "Healthy_control")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = TRUE,
         annotation_col = ann,
         annotation_colors = ann_col,
         main = "KEGG Chemokine Signaling Pathway",
         labels_row = rownames(subset), # figure out remove row labels
         fontsize_row = 6,
         color = hcl.colors(100, "PRGn",rev=F))


ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "KEGG Chemokine Signaling Pathway",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```

Reactome
```{R, message=F, warning=F}
# read in gmt file
pathway_reactome <- gmtPathways("/Users/aungphyo/Downloads/c2.cp.reactome.v2023.1.Hs.symbols.gmt.txt")
head(pathway, 1)
```

```{r, message=F, warning=F}
## convert result object to dataframe
res <- as.data.frame(res1)
res$hgnc_symbol <- rownames(res)

# compute summary stat
fgsea_rank <- res %>%
              dplyr::select(hgnc_symbol, log2FoldChange) %>%
              na.omit() %>%
              distinct() %>%
              group_by(hgnc_symbol) %>%
              summarize(log2foldchange=mean(log2FoldChange))

fgsea_rank
```

```{r}
rank <- deframe(fgsea_rank)
head(rank, 20)
```

```{R, message=F, warning=F}
# run fgsea
fgsea_reactome <- fgsea(pathways=pathway_reactome, stats=rank, nperm=7000)

fgseaResTidy_reactome <- fgsea_reactome %>%
  as_tibble() %>%
  arrange(desc(NES))

# Show in a nice table:
fgseaResTidy_reactome %>%
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>%
  arrange(padj) %>%
  DT::datatable()
```

```{r}
#fgseaResTidy_reactome<-fgseaResTidy_reactome[,-9]
fdr<- p.adjust(fgseaResTidy_reactome$pval, method="fdr")
fgseaResTidy_reactome<-cbind(fgseaResTidy_reactome,fdr)
```

Cluster Profiler of Reactome
```{r}
df <- as.data.frame(res1)
df$hgnc_symbol <- rownames(df)
info <- getBM(attributes=c("hgnc_symbol",
                           "entrezgene_id"),
                  filters = c("hgnc_symbol"),
                  values = df$hgnc_symbol,
                  mart = mart,
                  useCache=FALSE)
tmp <- merge(df, info, by="hgnc_symbol")

# subset the dataframe to include only stat sig genes
tmp <- tmp[tmp$padj < 0.05,]
```

```{r}
OrgDb <- org.Hs.eg.db

geneList <- as.vector(tmp$log2FoldChange)
names(geneList) <- as.character(tmp$entrezgene_id)
gene <- na.omit(as.character(tmp$entrezgene_id))
gene_list<-sort(geneList,decreasing = TRUE)

#gene_ids <- bitr(tmp, fromType = tmp$hgnc_symbol, toType =tmp$entrezgene_id, OrgDb = org.Hs.eg.db)

# Reactome over-representation test
ego_reactome <- enrichPathway(gene= gene,                                                                        organism = 'human',
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.01)
summary(ego_reactome)
head(summary(ego_reactome))

#Reactome gene set enrichment test
#ego_reactome<-gsePathway(geneList = gene_list,
                         #organism = 'human',
                         #pvalueCutoff = 0.001,
                         #pAdjustMethod = "BH")

#summary(ego_reactome)
```

```{r}
#y_reactome<-as.data.frame(ego_reactome)
#fdr<- p.adjust(y_reactome$pvalue, method="fdr")
#y_reactome<-cbind(y_reactome,fdr)
```

```{r,fig.height=4}
pdf("~/Desktop/X1R cluster.pdf", height = 11, width = 8)
dotplot(ego_reactome,x="GeneRatio",showCategory=20,font.size=9)
#dotplot(ego_reactome,x="GeneRatio",showCategory=20,font.size=6)
```

```{r,fig.width=8, fig.height=8}
#y_reactome<-as.data.frame(ego_reactome)
#fdr<- p.adjust(y_reactome$pvalue, method="fdr")
#y_reactome<-cbind(y_reactome,fdr)

#subset <- ego[ego$Count>=10, asis=T]
#cnetplot(ego,categorySize="geneNum",foldChange=geneList)
```


Enrichment plot
```{r}
filtered_pathway_reactome <- subset(fgseaResTidy_reactome, NES > 2.2)

filt_p <- as.vector(filtered_pathway_reactome$pathway)

for (i in filt_p){
    plt <- plotEnrichment(pathway = pathway_reactome[[i]],
    gseaParam = 1, ticksSize = 0.5, stats= rank) +
    labs(title=i) + theme(plot.title = element_text(hjust = 0.5, face="bold"))
    print(plt)
}
t3<-filtered_pathway_reactome
```

```{r,fig.width=5}
sub_reactome=filtered_pathway_reactome
sub_reactome$pathway = gsub("REACTOME_", "", sub_reactome$pathway)

pdf("~/Desktop/HCON_HCYTO_reactome_BUBBLE.pdf", height = 3, width = 7)
ggplot(sub_reactome, aes(x=NES, y=reorder(sub_reactome$pathway,sub_reactome$NES))) + 
  geom_point(aes(color=pval, size=size)) +
  labs(title = "",
       subtitle = "",
       x="Normalised Enrichment Score",
       y=NULL,
       color='P Adj',
       size = "Gene\nnumber") +
  theme_bw()
dev.off()
```


```{r,fig.height=6, fig.width=4}
reactome_IL= subset(fgsea_reactome, fgsea_reactome$pathway=="REACTOME_INTERLEUKIN_4_AND_INTERLEUKIN_13_SIGNALING")
reactome_IL= unlist(reactome_IL$leadingEdge)


subset <- rld[reactome_IL, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c("blue", "forestgreen")
names(col) <- c("Healthy_control", "Healthy_cytokine")
ann_col <- list(Condition = col)



ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "REACTOME_INTERLEUKIN_4_AND_INTERLEUKIN_13_SIGNALING",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```


```{r,fig.height=4, fig.width=6}
reactome_IL= subset(fgsea_reactome, fgsea_reactome$pathway=="REACTOME_CHEMOKINE_RECEPTORS_BIND_CHEMOKINES")
reactome_IL= unlist(reactome_IL$leadingEdge)


subset <- rld[reactome_IL, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c("blue", "forestgreen")
names(col) <- c("Healthy_control", "Healthy_cytokine")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = TRUE,
         annotation_col = ann,
         annotation_colors = ann_col,
         main = "REACTOME_CHEMOKINE_RECEPTORS_BIND_CHEMOKINES",
         labels_row = rownames(subset), # figure out remove row labels
         fontsize_row = 6,
         color = hcl.colors(100, "PRGn",rev=F))

ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "REACTOME_CHEMOKINE_RECEPTORS_BIND_CHEMOKINES",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```

```{r,fig.height=4, fig.width=6}
reactome_IL= subset(fgsea_reactome, fgsea_reactome$pathway=="REACTOME_INTERLEUKIN_10_SIGNALING")
reactome_IL= unlist(reactome_IL$leadingEdge)


subset <- rld[reactome_IL, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c("blue", "forestgreen")
names(col) <- c("Healthy_control", "Healthy_cytokine")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = TRUE,
         annotation_col = ann,
         annotation_colors = ann_col,
         main = "REACTOME_INTERLEUKIN_10_SIGNALING",
         labels_row = rownames(subset), # figure out remove row labels
         fontsize_row = 6,
         color = hcl.colors(100, "PRGn",rev=F))
pdf("~/Desktop/X1R IL10specific.pdf", height = 5, width = 6)
ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "REACTOME_INTERLEUKIN_10_SIGNALING",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```

```{r,fig.height=4, fig.width=6}
reactome_IL= subset(fgsea_reactome, fgsea_reactome$pathway=="REACTOME_PEPTIDE_LIGAND_BINDING_RECEPTORS")
reactome_IL= unlist(reactome_IL$leadingEdge)


subset <- rld[reactome_IL, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c("blue", "forestgreen")
names(col) <- c("Healthy_control", "Healthy_cytokine")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = TRUE,
         annotation_col = ann,
         annotation_colors = ann_col,
         main = "REACTOME_PEPTIDE_LIGAND_BINDING_RECEPTORS",
         labels_row = rownames(subset), # figure out remove row labels
         fontsize_row = 6,
         color = hcl.colors(100, "PRGn",rev=F))

ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "REACTOME_PEPTIDE_LIGAND_BINDING_RECEPTORS",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```

```{r,fig.height=8, fig.width=6}
reactome_IL= subset(fgsea_reactome, fgsea_reactome$pathway=="REACTOME_SIGNALING_BY_INTERLEUKINS")
reactome_IL= unlist(reactome_IL$leadingEdge)


subset <- rld[reactome_IL, 7:12]

# scale and center the values
mat <- as.matrix(scale(t(subset), center = T))

# basic plot to check we're plotting something sensible
#pheatmap(t(mat))

# spruce it up a bit..
ann <- data.frame(Condition = c(rep("Healthy_control", 3), rep("Healthy_cytokine", 3)))
rownames(ann) <- rownames(mat)
col <- c("blue", "forestgreen")
names(col) <- c("Healthy_control", "Healthy_cytokine")
ann_col <- list(Condition = col)

pheatmap(t(mat), 
         show_rownames = TRUE,
         annotation_col = ann,
         annotation_colors = ann_col,
         main = "REACTOME_SIGNALING_BY_INTERLEUKINS",
         labels_row = rownames(subset), # figure out remove row labels
         fontsize_row = 6,
         color = hcl.colors(100, "PRGn",rev=F))

ComplexHeatmap::pheatmap(t(mat),
                        show_rownames = T,
                        annotation_col = ann,
                        annotation_colors = ann_col,
                        main = "REACTOME_SIGNALING_BY_INTERLEUKINS",
                        labels_row = rownames(subset),
                        fontsize = 6,
                        legend = TRUE,
                       heatmap_legend_param =list(title="z-score",at=c (-1.5,-1,-0.5,0,0.5,1,1.5)),
        color=hcl.colors(100, 'PRGn',rev=F))

```

```{r}
tabl<-rbind(t1,t2,t3)
#writeLines(dput(tabl), "my_list.txt")
#write.csv(data.frame(tabl), "tabl.csv", row.names = FALSE)
```
